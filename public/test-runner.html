<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KingsHMS Database Test Runner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }

        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        .button:hover {
            background: #45a049;
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 20px;
        }

        .success {
            color: #4CAF50;
        }

        .error {
            color: #f44336;
        }

        .warning {
            color: #ff9800;
        }

        .info {
            color: #2196F3;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #2196F3;
            background: #f9f9f9;
        }

        .progress {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            height: 100%;
            transition: width 0.3s;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h1>üîç KingsHMS Database Test Runner</h1>

    <div class="test-container">
        <h2>Database Testing Interface</h2>
        <p>This tool tests all aspects of the KingsHMS database system including Firebase configuration, data
            operations, security, and performance.</p>

        <div class="test-section">
            <h3>Quick Actions</h3>
            <button class="button" onclick="runAllTests()">üöÄ Run All Tests</button>
            <button class="button" onclick="runCRUDOnly()">üìù CRUD Tests Only</button>
            <button class="button" onclick="runSecurityTests()">üîí Security Tests</button>
            <button class="button" onclick="clearOutput()">üóëÔ∏è Clear Output</button>
        </div>

        <div class="test-section">
            <h3>Individual Tests</h3>
            <button class="button" onclick="testFirebase()">Firebase Config</button>
            <button class="button" onclick="testService()">Database Service</button>
            <button class="button" onclick="testReadOps()">Read Operations</button>
            <button class="button" onclick="testPerformance()">Performance</button>
        </div>

        <div id="progress-container" style="display:none;">
            <div class="progress">
                <div class="progress-bar" id="progress-bar">0%</div>
            </div>
        </div>
    </div>

    <div id="output"></div>

    <script type="module">
        const output = document.getElementById('output');

        function log(message, type = 'info') {
            const colors = {
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800',
                info: '#d4d4d4'
            };
            const span = document.createElement('span');
            span.style.color = colors[type];
            span.textContent = message + '\n';
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progress-bar');
            const container = document.getElementById('progress-container');
            container.style.display = 'block';
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
        }

        window.clearOutput = () => {
            output.innerHTML = '';
            document.getElementById('progress-container').style.display = 'none';
        };

        // Test 1: Firebase Configuration
        window.testFirebase = async () => {
            log('üìã Test: Firebase Configuration', 'info');
            log('‚îÄ'.repeat(50), 'info');
            try {
                const { app, analytics, storage } = await import('./services/firebase.ts');
                log('‚úÖ Firebase app initialized', 'success');
                log('‚úÖ Firebase analytics available', 'success');
                log('‚úÖ Firebase storage available', 'success');
                log(`üì¶ Project: ${app.options.projectId}`, 'info');
                return true;
            } catch (error) {
                log(`‚ùå Firebase test failed: ${error.message}`, 'error');
                return false;
            }
        };

        // Test 2: Database Service
        window.testService = async () => {
            log('\nüìã Test: Database Service', 'info');
            log('‚îÄ'.repeat(50), 'info');
            try {
                const { dbService } = await import('./services/dbService.ts');
                log('‚úÖ Database service loaded', 'success');

                const methods = ['getAll', 'getById', 'create', 'update', 'delete'];
                methods.forEach(method => {
                    if (typeof dbService[method] === 'function') {
                        log(`‚úÖ Method: ${method}()`, 'success');
                    }
                });
                return true;
            } catch (error) {
                log(`‚ùå Service test failed: ${error.message}`, 'error');
                return false;
            }
        };

        // Test 3: Read Operations
        window.testReadOps = async () => {
            log('\nüìã Test: Data Read Operations', 'info');
            log('‚îÄ'.repeat(50), 'info');
            try {
                const { dbService } = await import('./services/dbService.ts');
                const tables = ['rooms', 'bookings', 'staff', 'guests', 'menu'];

                for (const table of tables) {
                    const data = await dbService.getAll(table);
                    log(`‚úÖ ${table.padEnd(12, ' ')} - ${data.length} records`, 'success');
                }
                return true;
            } catch (error) {
                log(`‚ùå Read test failed: ${error.message}`, 'error');
                return false;
            }
        };

        // Test 4: CRUD Operations
        window.testCRUD = async () => {
            log('\nüìã Test: CRUD Operations', 'info');
            log('‚îÄ'.repeat(50), 'info');
            try {
                const { dbService } = await import('./services/dbService.ts');

                // CREATE
                log('\nüîπ CREATE Test:', 'info');
                const testData = {
                    name: `Test User ${Date.now()}`,
                    email: `test${Date.now()}@test.com`,
                    role: 'admin',
                    department: 'Testing',
                    hireDate: new Date().toISOString().split('T')[0],
                    status: 'active'
                };

                const created = await dbService.create('staff', testData);
                log(`‚úÖ Created record: ${created.id}`, 'success');

                // READ
                log('\nüîπ READ Test:', 'info');
                const read = await dbService.getById('staff', created.id);
                if (read && read.email === testData.email) {
                    log('‚úÖ Record retrieved successfully', 'success');
                }

                // UPDATE
                log('\nüîπ UPDATE Test:', 'info');
                const updated = await dbService.update('staff', created.id, {
                    department: 'Updated Dept'
                });
                if (updated && updated.department === 'Updated Dept') {
                    log('‚úÖ Record updated successfully', 'success');
                }

                // DELETE
                log('\nüîπ DELETE Test:', 'info');
                const deleted = await dbService.delete('staff', created.id);
                if (deleted) {
                    log('‚úÖ Record deleted successfully', 'success');
                }

                return true;
            } catch (error) {
                log(`‚ùå CRUD test failed: ${error.message}`, 'error');
                log(`   ${error.stack}`, 'error');
                return false;
            }
        };

        // Test 5: Security
        window.testSecurity = async () => {
            log('\nüìã Test: Security & Sanitization', 'info');
            log('‚îÄ'.repeat(50), 'info');
            try {
                const { sanitizeId, sanitizeObject, isNoSQLInjection } =
                    await import('./services/security.ts');

                log('‚úÖ Security service loaded', 'success');

                // Test injection detection
                const injections = [
                    '{ "$gt": "" }',
                    '{ "$ne": null }',
                    "admin' OR 1=1--"
                ];

                let passed = 0;
                for (const inj of injections) {
                    if (isNoSQLInjection(inj)) {
                        passed++;
                    }
                }

                if (passed === injections.length) {
                    log(`‚úÖ NoSQL injection detection: ${passed}/${injections.length}`, 'success');
                } else {
                    log(`‚ö†Ô∏è  NoSQL detection: ${passed}/${injections.length}`, 'warning');
                }

                return true;
            } catch (error) {
                log(`‚ùå Security test failed: ${error.message}`, 'error');
                return false;
            }
        };

        // Test 6: Performance
        window.testPerformance = async () => {
            log('\nüìã Test: Performance', 'info');
            log('‚îÄ'.repeat(50), 'info');
            try {
                const { dbService } = await import('./services/dbService.ts');

                const start = performance.now();
                await Promise.all([
                    dbService.getAll('rooms'),
                    dbService.getAll('bookings'),
                    dbService.getAll('staff'),
                    dbService.getAll('guests')
                ]);
                const duration = performance.now() - start;

                log(`‚è±Ô∏è  Parallel read: ${duration.toFixed(2)}ms`, 'info');

                if (duration < 1000) {
                    log('‚úÖ Performance: Excellent', 'success');
                } else if (duration < 3000) {
                    log('‚ö†Ô∏è  Performance: Good', 'warning');
                } else {
                    log('‚ö†Ô∏è  Performance: Needs optimization', 'warning');
                }

                return true;
            } catch (error) {
                log(`‚ùå Performance test failed: ${error.message}`, 'error');
                return false;
            }
        };

        // Run all tests
        window.runAllTests = async () => {
            clearOutput();
            log('üöÄ KingsHMS Database Test Suite', 'info');
            log('‚ïê'.repeat(50), 'info');
            log('Starting comprehensive database tests...\n', 'info');

            const tests = [
                { name: 'Firebase Config', fn: testFirebase },
                { name: 'Database Service', fn: testService },
                { name: 'Read Operations', fn: testReadOps },
                { name: 'CRUD Operations', fn: testCRUD },
                { name: 'Security', fn: testSecurity },
                { name: 'Performance', fn: testPerformance }
            ];

            let passed = 0;
            const total = tests.length;

            for (let i = 0; i < tests.length; i++) {
                updateProgress(((i) / total) * 100);
                try {
                    const result = await tests[i].fn();
                    if (result) passed++;
                } catch (error) {
                    log(`\n‚ùå Test "${tests[i].name}" error: ${error.message}`, 'error');
                }
                await new Promise(r => setTimeout(r, 100));
            }

            updateProgress(100);

            log('\n\nüìä TEST SUMMARY', 'info');
            log('‚ïê'.repeat(50), 'info');
            log(`Total Tests:  ${total}`, 'info');
            log(`Passed:       ${passed}`, passed === total ? 'success' : 'warning');
            log(`Failed:       ${total - passed}`, total - passed === 0 ? 'success' : 'error');
            log(`Success Rate: ${((passed / total) * 100).toFixed(1)}%`, 'info');

            if (passed === total) {
                log('\nüéâ All tests passed! Database is ready.', 'success');
            } else {
                log('\n‚ö†Ô∏è  Some tests failed. Please review above.', 'warning');
            }
        };

        window.runCRUDOnly = async () => {
            clearOutput();
            await testCRUD();
        };

        window.runSecurityTests = async () => {
            clearOutput();
            await testSecurity();
        };

        // Auto-run on load
        log('‚ú® Database Test Runner loaded successfully!', 'success');
        log('Click "Run All Tests" to begin testing.\n', 'info');
    </script>
</body>

</html>